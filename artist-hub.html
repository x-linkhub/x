<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon"
  href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='96'>ðŸŽµ</text></svg>">
  <title>Artist Hub</title>
  <style>
    :root{
      --bg: #0b0f14;
      --surface: #121821;
      --surface-2: #151c26;
      --text: #e8eef6;
      --muted: #9fb0c3;
      --accent: #8b5cf6;
      --accent-2:#22d3ee;
      --card-radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 80% -10%, rgba(139,92,246,.15), transparent 45%),
                  radial-gradient(900px 900px at 0% 10%, rgba(34,211,238,.12), transparent 40%),
                  var(--bg);
      color:var(--text);
      letter-spacing:.2px;
    }
    a{color:inherit}
    .container{max-width:1000px; margin:0 auto; padding:24px;}

    /* Header */
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .bar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 24px;}
    .left, .right{display:flex; align-items:center; gap:10px}

    .btn{
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px;
      background: linear-gradient(180deg, var(--surface), var(--surface-2));
      border:1px solid rgba(255,255,255,.06);
      color:var(--text); text-decoration:none; cursor:pointer;
      transition:.2s transform,.2s background,.2s border-color, .2s opacity; box-shadow: var(--shadow);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.12)}
    .btn:active{ transform: translateY(0)}
    .btn.primary{ background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 30%, var(--surface)), var(--surface-2)); border-color: color-mix(in oklab, var(--accent) 45%, rgba(255,255,255,.06)); }
    .btn.ghost{ background: transparent; border-color: rgba(255,255,255,.12)}

    /* Center title */
    .title{ position:relative; font-weight:800; font-size: clamp(22px, 3.4vw, 38px); letter-spacing:.5px; text-transform:uppercase; background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; background-clip:text; color: transparent; }
    .title .shimmer{position:absolute; inset:0; background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.7) 50%, transparent 100%); transform: skewX(-20deg) translateX(-120%); filter: blur(4px); mix-blend-mode: overlay; animation: shimmer 3.8s infinite;}
    @keyframes shimmer{ 60%{ transform: skewX(-20deg) translateX(120%) } 100%{ transform: skewX(-20deg) translateX(120%) } }

    /* Utility */
    .spacer{flex:1}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .muted{ color: var(--muted); font-size:.92rem }

    /* Search */
    .search{ width:100%; margin:18px 0 10px; display:flex; gap:10px; }
    .search input{ flex:1; padding:14px 16px; border-radius:14px; border:1px solid rgba(255,255,255,.09); background: linear-gradient(180deg, var(--surface), var(--surface-2)); color:var(--text); outline:none; box-shadow: inset 0 2px 10px rgba(0,0,0,.25); }

    /* Cards */
    .list{ display:flex; flex-direction:column; gap:16px; }
    .card{ background: linear-gradient(180deg, color-mix(in oklab, var(--surface) 70%, #000), var(--surface-2)); border:1px solid rgba(255,255,255,.07); border-radius: var(--card-radius); box-shadow: var(--shadow); padding:16px 16px 14px; position:relative; overflow:hidden; }
    .card:hover{ border-color: rgba(255,255,255,.14)}
    .card .header{ display:flex; align-items:center; gap:10px; }
    .card h3{ margin:0; font-size:1.05rem; letter-spacing:.3px }

    .links{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .link-chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); text-decoration:none; }
    .link-chip:hover{ border-color: rgba(255,255,255,.16) }
    .link-chip svg{ width:18px; height:18px }

    .videos{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px }
    @media (min-width: 760px){ .videos{ grid-template-columns: 1fr 1fr } }
    .video{ position:relative; width:100%; padding-top:56.25%; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
    .video iframe{ position:absolute; inset:0; width:100%; height:100%; border:0 }

    /* Actions */
    .actions{ margin-left:auto; display:flex; gap:6px }
    .icon-btn{ background:transparent; border:1px solid rgba(255,255,255,.14); padding:8px; border-radius:10px; cursor:pointer; color:var(--text)}
    .icon-btn:hover{ border-color: rgba(255,255,255,.25) }

    footer{ opacity:.8; font-size:.9rem; padding:26px 0; }

    /* Modal (Add/Edit) */
    dialog{ border:0; border-radius:16px; background: linear-gradient(180deg, var(--surface), var(--surface-2)); color:var(--text); width:min(680px, 92vw); box-shadow: var(--shadow); }
    dialog::backdrop{ background: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08) }
    .modal-body{ padding:14px 16px 18px; display:grid; gap:12px }
    .field label{ display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px }
    .field input, .field textarea{ width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, var(--surface), var(--surface-2)); color:var(--text); outline:none; }

    .links-editor{ display:grid; gap:8px }
    .link-row{ display:grid; grid-template-columns: 1fr auto; gap:8px }
    .hidden{ display:none !important }

    /* Menu dialog */
    #menuDialog .modal-body{ gap:14px }
    .menu-row{ display:flex; align-items:center; justify-content:space-between; gap:10px }

    /* --- Editor gate --- */
    #addBtn, #menuBtn, .actions { display: none !important; }
    body.editor #addBtn, body.editor #menuBtn { display: inline-flex !important; }
    body.editor .actions { display: flex !important; }

    /* --- Auth UI (always visible) --- */
    .auth { position: relative; display:flex; align-items:center; gap:10px; }
    #loginBtnG {
      width:36px; height:36px; display:inline-grid; place-items:center;
      border-radius:50%; border:1px solid rgba(255,255,255,.14); background:transparent; cursor:pointer;
      font-weight:800; letter-spacing:.5px;
    }
    #loginBtnG:hover { border-color: rgba(255,255,255,.3); }
    #loginBtnG span { font-size:16px; }
    .avatar {
      width:36px; height:36px; display:inline-grid; place-items:center;
      border-radius:50%; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, var(--surface), var(--surface-2)); cursor:pointer; overflow:hidden;
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:none; }
    .avatar span { font-weight:800; }
    .auth-menu {
      position:absolute; top:44px; right:0; width:220px;
      background:linear-gradient(180deg, var(--surface), var(--surface-2)); border:1px solid rgba(255,255,255,.12);
      border-radius:12px; box-shadow: var(--shadow); padding:10px; z-index:20;
    }
    .auth-menu .email { font-size:.85rem; color:var(--muted); margin:6px 4px 10px; word-break:break-all; }
    .auth-menu .row { justify-content: flex-end; }

    /* Sync pill */
    #syncStatus{ font-size:.85rem; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="left">
        <a class="btn" href="index.html" title="Back to Link Hub">âŸµ Link Hub</a>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <h1 class="title" aria-label="Artist Hub">Artist Hub<div class="shimmer"></div></h1>
      </div>
      <div class="spacer"></div>
      <div class="right">
        <span id="syncStatus" class="muted" title="Sync status">Read-only</span>

        <!-- Auth UI (always visible) -->
        <div class="auth" id="authArea">
          <button id="loginBtnG" class="icon-btn" title="Sign in with Google"><span>G</span></button>
          <button id="avatarBtn" class="avatar hidden" title="Account">
            <img id="avatarImg" alt="User avatar"/>
            <span id="avatarInitial">?</span>
          </button>
          <div id="authMenu" class="auth-menu hidden">
            <div class="email" id="userEmail">Signed in</div>
            <div class="row">
              <button id="signOutBtn" class="btn ghost">Sign out</button>
            </div>
          </div>
        </div>

        <!-- Editor controls (gated by body.editor) -->
        <button id="addBtn" class="btn primary" title="Add artist">ï¼‹ Add Artist</button>
        <button id="menuBtn" class="btn" title="Menu">â˜° Menu</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="search">
      <input id="searchInput" type="search" placeholder="Search artistsâ€¦ (name or platform)"/>
    </div>

    <section id="list" class="list" aria-live="polite"></section>

    <footer class="container">
      <div class="muted">2025.<strong>AH - 2v (Firestore)</strong></div>
    </footer>
  </main>

  <!-- Add/Edit Modal -->
  <dialog id="artistDialog">
    <form id="artistForm" method="dialog">
      <div class="modal-head">
        <strong id="dialogTitle">Add Artist</strong>
        <div class="row">
          <button type="button" id="cancelDialog" class="btn ghost">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="artistName">Artist name</label>
          <input id="artistName" required placeholder="e.g., NÃ¸xcrya"/>
        </div>

        <div class="field">
          <label>Platform links <small>(paste URLs â€“ icons auto-detect & colored)</small></label>
          <div id="linksEditor" class="links-editor"></div>
          <div class="row">
            <button type="button" id="addLinkRow" class="btn">ï¼‹ Add link</button>
            <span class="muted">Examples: https://youtube.com/@name â€¢ https://open.spotify.com/artist/â€¦ â€¢ https://soundcloud.com/â€¦</span>
          </div>
        </div>

        <div class="field">
          <label for="videos">Featured YouTube videos <small>(one URL per line)</small></label>
          <textarea id="videos" rows="4" placeholder="https://youtu.be/xxxxxxxxxxx&#10;https://www.youtube.com/watch?v=xxxxxxxxxxx"></textarea>
        </div>

        <input type="hidden" id="editingId" />
      </div>
    </form>
  </dialog>

  <!-- Menu Modal (Import/Export) -->
  <dialog id="menuDialog">
    <div class="modal-head">
      <strong>Menu</strong>
      <button type="button" id="closeMenu" class="btn ghost">Close</button>
    </div>
    <div class="modal-body">
      <div class="menu-row">
        <div>
          <div><strong>Export JSON</strong></div>
          <div class="muted">Download your artists as a backup file.</div>
        </div>
        <button id="exportBtn" class="btn">â‡© Export</button>
      </div>
      <div class="menu-row">
        <div>
          <div><strong>Import JSON</strong></div>
          <div class="muted">Restore from a file exported earlier.</div>
        </div>
        <div>
          <label class="btn" for="importFile">Importâ€¦</label>
          <input id="importFile" class="hidden" type="file" accept="application/json"/>
        </div>
      </div>
    </div>
  </dialog>

  <template id="linkRowTpl">
    <div class="link-row">
      <input type="url" placeholder="Paste platform URL" />
      <button type="button" class="btn ghost remove-link">âœ•</button>
    </div>
  </template>

  <script type="module">
    window.addEventListener('error', (e)=>console.error('Global error:', e.message||e));
    window.addEventListener('unhandledrejection', (e)=>console.error('Unhandled promise:', e.reason||e));

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence,
             browserLocalPersistence, browserSessionPersistence,
             GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, writeBatch, enableIndexedDbPersistence, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBvWLRZjEyldAYZXfK6KV2H9_P5fLOsGMw",
      authDomain: "link-library-1dfc8.firebaseapp.com",
      projectId: "link-library-1dfc8",
      storageBucket: "link-library-1dfc8.firebasestorage.app",
      messagingSenderId: "368329977627",
      appId: "1:368329977627:web:625d20247d6aea3b9cadbe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Robust persistence setup
    try {
      await setPersistence(auth, browserLocalPersistence);
      console.log('[auth] persistence: local');
    } catch (e) {
      console.warn('[auth] local persistence failed, falling back to session:', e?.code || e);
      try {
        await setPersistence(auth, browserSessionPersistence);
        console.log('[auth] persistence: session');
      } catch (e2) {
        console.warn('[auth] session persistence failed:', e2?.code || e2);
      }
    }

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // Firestore
    const db = getFirestore(app);
    try { await enableIndexedDbPersistence(db); } catch(e) { console.warn('Persistence unavailable', e?.code || e); }

    const COL = 'artists';
    const qArtists = query(collection(db, COL), orderBy('order', 'asc'), orderBy('createdAt', 'asc'));

    // Whitelisted emails that can edit (UI gate) â€” protect with Firestore rules too
    const ALLOWED_EMAILS = ["xq.dannybs@gmail.com", "dafuke88@gmail.com"];

    // --- Auth UI elements ---
    const loginBtn  = document.getElementById("loginBtnG");
    const avatarBtn = document.getElementById("avatarBtn");
    const avatarImg = document.getElementById("avatarImg");
    const avatarInitial = document.getElementById("avatarInitial");
    const authMenu  = document.getElementById("authMenu");
    const signOutBtn = document.getElementById("signOutBtn");
    const userEmailEl = document.getElementById("userEmail");
    const syncStatus = document.getElementById("syncStatus");

    function hide(el, yes=true){ if(!el) return; el.classList.toggle("hidden", !!yes); }
    function show(el){ hide(el, false); }

    function firstInitialFrom(u){
      const s = (u?.displayName || u?.email || "?").trim();
      return s ? s[0].toUpperCase() : "?";
    }

    function updateAuthUI(u){
      if(u){
        userEmailEl.textContent = u.email || u.uid;
        if(u.photoURL){
          avatarImg.src = u.photoURL;
          avatarImg.alt = u.displayName || "User";
          show(avatarImg);
          hide(avatarInitial, true);
        } else {
          hide(avatarImg, true);
          avatarInitial.textContent = firstInitialFrom(u);
          show(avatarInitial);
        }
        hide(loginBtn, true);
        show(avatarBtn);
      } else {
        userEmailEl.textContent = "";
        hide(avatarImg, true);
        avatarInitial.textContent = "?" ;
        hide(avatarBtn, true);
        show(loginBtn);
        hide(authMenu, true);
      }
    }

    function setEditorGate(u){
      const ok = !!u && ALLOWED_EMAILS.includes(u.email || "");
      document.body.classList.toggle("editor", ok);
      syncStatus.textContent = ok ? "Editing (synced)" : "Read-only";
    }

    onAuthStateChanged(auth, (u) => {
      console.log('[auth] state changed:', !!u, u?.email);
      updateAuthUI(u);
      setEditorGate(u);
    });

    loginBtn?.addEventListener("click", async () => {
      console.log('[auth] login click');
      try{
        await signInWithPopup(auth, provider);
        console.log('[auth] popup opened');
      }catch(e){
        console.warn('[auth] popup error:', e?.code, e?.message);
        // Common cases: popup-blocked, popup-closed-by-user, third-party cookies
        if (e?.code === "auth/popup-blocked" ||
            e?.code === "auth/popup-closed-by-user" ||
            e?.code === "auth/cancelled-popup-request" ||
            e?.code === "auth/operation-not-supported-in-this-environment") {
          console.log('[auth] using redirect fallbackâ€¦');
          await signInWithRedirect(auth, provider);
        } else if (e?.code === "auth/unauthorized-domain") {
          alert('Firebase Auth: unauthorized domain.\nAdd "x-linkhub.github.io" in Firebase Console â†’ Authentication â†’ Settings â†’ Authorized domains.');
        } else {
          alert("Sign-in failed: " + (e.message || e));
        }
      }
    });

    function toggleMenu(){
      authMenu.classList.toggle("hidden");
    }
    avatarBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu();
    });
    document.addEventListener("click", (e) => {
      if(!authMenu.classList.contains("hidden")){
        const within = e.target.closest("#authMenu") || e.target.closest("#avatarBtn");
        if(!within) hide(authMenu, true);
      }
    });
    signOutBtn?.addEventListener("click", async () => {
      hide(authMenu, true);
      await signOut(auth);
    });

    // ===== App state (Firestore-powered) =====
    const els = {
      list: document.getElementById('list'),
      addBtn: document.getElementById('addBtn'),
      menuBtn: document.getElementById('menuBtn'),
      menuDialog: document.getElementById('menuDialog'),
      closeMenu: document.getElementById('closeMenu'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      search: document.getElementById('searchInput'),
      dialog: document.getElementById('artistDialog'),
      form: document.getElementById('artistForm'),
      dialogTitle: document.getElementById('dialogTitle'),
      cancelDialog: document.getElementById('cancelDialog'),
      name: document.getElementById('artistName'),
      linksEditor: document.getElementById('linksEditor'),
      addLinkRow: document.getElementById('addLinkRow'),
      videos: document.getElementById('videos'),
      editingId: document.getElementById('editingId'),
    };

    const state = { artists: [], filter: '' };
    window.__state = state;

    // Live subscription
    let unsubscribe = null;
    function listen(){
      if(unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(qArtists, (snap) => {
        const arr = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          arr.push({
            id: docSnap.id,
            name: d.name || 'Untitled',
            links: Array.isArray(d.links) ? d.links : [],
            videos: Array.isArray(d.videos) ? d.videos : [],
            order: typeof d.order === 'number' ? d.order : 0,
            createdAt: d.createdAt?.toMillis ? d.createdAt.toMillis() : 0,
            updatedAt: d.updatedAt?.toMillis ? d.updatedAt.toMillis() : 0,
          });
        });
        state.artists = arr;
        render();
      }, (err)=>{
        console.error('Live read failed:', err);
        syncStatus.textContent = 'Offline / error';
      });
    }
    listen();

    function render(){
      const term = state.filter.trim().toLowerCase();
      const items = !term ? state.artists : state.artists.filter(a =>
        a.name.toLowerCase().includes(term) || a.links.some(l => (l.platform||'').toLowerCase().includes(term))
      );

      els.list.innerHTML = '';
      if(items.length === 0){
        const empty = document.createElement('div');
        empty.className = 'card muted';
        empty.style.textAlign = 'center';
        empty.style.padding = '30px';
        empty.textContent = 'No artists yet. Click â€œAdd Artistâ€ to create your first one!';
        els.list.appendChild(empty);
        return;
      }

      for(const a of items){ els.list.appendChild(artistCard(a)); }
    }
    window.__render = render;

    function artistCard(a){
      const card = document.createElement('article');
      card.className = 'card'; card.dataset.id = a.id;

      const head = document.createElement('div'); head.className = 'header';
      const title = document.createElement('h3'); title.textContent = a.name;
      head.appendChild(title);
      const actions = document.createElement('div'); actions.className = 'actions';
      actions.appendChild(iconButton('â†‘','Move up','move-up'));
      actions.appendChild(iconButton('â†“','Move down','move-down'));
      actions.appendChild(iconButton('âœŽ','Edit','edit'));
      actions.appendChild(iconButton('ðŸ—‘','Delete','delete'));
      head.appendChild(actions);
      card.appendChild(head);

      if(a.links?.length){
        const links = document.createElement('div'); links.className = 'links';
        a.links.forEach(link => {
          const chip = document.createElement('a');
          chip.className = 'link-chip'; chip.href = link.url; chip.target = '_blank' ; chip.rel = 'noopener noreferrer';
          chip.title = link.url;
          chip.innerHTML = iconSVG(link.platform) + `<span>${link.platform}</span>`;
          links.appendChild(chip);
        });
        card.appendChild(links);
      }

      if(a.videos?.length){
        const videos = document.createElement('div'); videos.className = 'videos';
        a.videos.forEach(id => {
          const wrap = document.createElement('div'); wrap.className = 'video';
          wrap.innerHTML = `<iframe loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen src="https://www.youtube-nocookie.com/embed/${id}"></iframe>`;
          videos.appendChild(wrap);
        });
        card.appendChild(videos);
      }

      return card;
    }

    function iconButton(label, title, action){
      const b = document.createElement('button'); b.className = 'icon-btn'; b.title = title; b.dataset.action = action; b.textContent = label; return b;
    }

    // ---------- Dialog (Add/Edit) ----------
    function openAdd(){
      els.dialogTitle.textContent = 'Add Artist';
      els.name.value = '';
      els.videos.value = '';
      els.editingId.value = '';
      resetLinksEditor();
      addLinkInput();
      els.dialog.showModal();
      setTimeout(() => els.name.focus(), 0);
    }

    function openEdit(id){
      const a = state.artists.find(x => x.id === id);
      if(!a) return;
      els.dialogTitle.textContent = 'Edit Artist';
      els.name.value = a.name;
      els.videos.value = (a.videos||[]).map(v => `https://youtu.be/${v}`).join('\\n');
      els.editingId.value = id;
      resetLinksEditor();
      if(a.links?.length){ a.links.forEach(l => addLinkInput(l.url)); } else { addLinkInput(); }
      els.dialog.showModal();
      setTimeout(() => els.name.focus(), 0);
    }

    els.cancelDialog.addEventListener('click', () => els.dialog.close());

    els.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = els.name.value.trim();
      if(!name){ alert('Please enter an artist name.'); return; }

      const urls = Array.from(els.linksEditor.querySelectorAll('input[type="url"]'))
        .map(i => i.value.trim()).filter(Boolean);
      const links = urls.map(u => ({ platform: detectPlatform(u), url: u }));

      const videosRaw = els.videos.value.split(/\\n|,|;/).map(s => s.trim()).filter(Boolean);
      const vids = [];
      for(const v of videosRaw){
        const id = parseYouTubeId(v);
        if(id) vids.push(id);
      }

      const existingId = els.editingId.value;
      try{
        if(existingId){
          await updateDoc(doc(db, COL, existingId), { name, links, videos: vids, updatedAt: serverTimestamp() });
        } else {
          const nextOrder = state.artists.length ? (Math.max(...state.artists.map(a => a.order||0)) + 1000) : 1000;
          await addDoc(collection(db, COL), { name, links, videos: vids, order: nextOrder, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        }
        els.dialog.close();
      }catch(err){
        console.error('Save failed', err);
        alert('Save failed. Are you signed in with an allowed email?');
      }
    });

    function resetLinksEditor(){ els.linksEditor.innerHTML = ''; }

    function addLinkInput(value=''){
      const tpl = document.getElementById('linkRowTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      const input = node.querySelector('input'); input.value = value; input.placeholder = exampleFor(value);
      node.querySelector('.remove-link').addEventListener('click', () => node.remove());
      els.linksEditor.appendChild(node);
    }

    function exampleFor(v){
      const p = detectPlatform(v);
      const map = {
        'YouTube': 'https://www.youtube.com/@channel',
        'Spotify': 'https://open.spotify.com/artist/â€¦',
        'SoundCloud': 'https://soundcloud.com/artist',
        'Apple Music': 'https://music.apple.com/artist/â€¦',
        'Bandcamp': 'https://artist.bandcamp.com',
        'Instagram': 'https://instagram.com/â€¦',
        'TikTok': 'https://www.tiktok.com/@â€¦',
        'X': 'https://x.com/â€¦',
        'Deezer': 'https://www.deezer.com/artist/â€¦',
        'Tidal': 'https://tidal.com/browse/artist/â€¦',
        'Website': 'https://your-site.com'
      };
      return map[p] || 'https://â€¦';
    }

    els.addLinkRow.addEventListener('click', () => addLinkInput());

    // ---------- List events (Edit/Delete/Move) ----------
    els.list.addEventListener('click', async (e) => {
      const btn = e.target.closest('button.icon-btn');
      if(!btn) return;
      const card = e.target.closest('.card');
      const id = card?.dataset.id;
      if(!id) return;
      const action = btn.dataset.action;
      const ix = state.artists.findIndex(a => a.id === id);
      if(ix < 0) return;
      try{
        if(action === 'delete'){
          if(confirm('Delete this artist?')){
            await deleteDoc(doc(db, COL, id));
          }
        }else if(action === 'edit'){
          openEdit(id);
        }else if(action === 'move-up'){
          if(ix>0){
            const above = state.artists[ix-1]; const cur = state.artists[ix];
            const batch = writeBatch(db);
            batch.update(doc(db, COL, cur.id), { order: (above.order||0) - 1, updatedAt: serverTimestamp() });
            batch.update(doc(db, COL, above.id), { updatedAt: serverTimestamp() });
            await batch.commit();
            maybeNormalizeOrder();
          }
        }else if(action === 'move-down'){
          if(ix < state.artists.length-1){
            const below = state.artists[ix+1]; const cur = state.artists[ix];
            const batch = writeBatch(db);
            batch.update(doc(db, COL, cur.id), { order: (below.order||0) + 1, updatedAt: serverTimestamp() });
            batch.update(doc(db, COL, below.id), { updatedAt: serverTimestamp() });
            await batch.commit();
            maybeNormalizeOrder();
          }
        }
      }catch(err){
        console.error('Action failed', err);
        alert('Action failed. Check your sign-in and permissions.');
      }
    });

    // Normalize order values (optional)
    let normalizeTimer = null;
    function maybeNormalizeOrder(){
      clearTimeout(normalizeTimer);
      normalizeTimer = setTimeout(async () => {
        const snap = await getDocs(qArtists);
        const batch = writeBatch(db);
        let n = 1000;
        snap.forEach((docSnap)=>{
          batch.update(doc(db, COL, docSnap.id), { order: n, updatedAt: serverTimestamp() });
          n += 1000;
        });
        await batch.commit().catch(()=>{});
      }, 600);
    }

    // ---------- Toolbar ----------
    els.addBtn.addEventListener('click', openAdd);

    // Menu dialog
    els.menuBtn.addEventListener('click', () => els.menuDialog.showModal());
    els.closeMenu.addEventListener('click', () => els.menuDialog.close());

    // Export
    els.exportBtn.addEventListener('click', () => {
      const payload = state.artists.map(a => ({
        name: a.name, links: a.links, videos: a.videos, order: a.order
      }));
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'artist-hub-export.json'; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 2000);
    });

    // Import: batch add
    els.importFile.addEventListener('change', (e) => {
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader(); reader.onload = async () => {
        try{
          const data = JSON.parse(reader.result);
          if(Array.isArray(data)){
            const base = state.artists.length ? Math.max(...state.artists.map(a => a.order||0)) + 1000 : 1000;
            let n = 0;
            const batch = writeBatch(db);
            for(const x of data){
              const name = String(x.name||'Untitled');
              const links = Array.isArray(x.links) ? x.links.map(l => ({ platform: l.platform || detectPlatform(l.url||''), url: String(l.url||'') })) : [];
              const videos = Array.isArray(x.videos) ? x.videos.filter(Boolean) : [];
              const order = typeof x.order === 'number' ? x.order : base + (n++ * 1000);
              const ref = doc(collection(db, COL));
              batch.set(ref, { name, links, videos, order, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
            }
            await batch.commit();
            alert('Import complete.');
          } else { alert('Invalid JSON format: expected an array'); }
        }catch(err){ alert('Import failed: ' + err.message); }
        finally { e.target.value = ''; }
      };
      reader.readAsText(file);
    });

    // ---------- Helpers ----------
    function detectPlatform(url){
      try{ const u = new URL(url); const h = u.hostname.replace('www.','');
        if(h.includes('youtube') || h.includes('youtu.be')) return 'YouTube';
        if(h.includes('open.spotify.com')) return 'Spotify';
        if(h.includes('soundcloud.com')) return 'SoundCloud';
        if(h.includes('music.apple.com')) return 'Apple Music';
        if(h.includes('bandcamp.com')) return 'Bandcamp';
        if(h.includes('instagram.com')) return 'Instagram';
        if(h.includes('tiktok.com')) return 'TikTok';
        if(h === 'x.com' || h.includes('twitter.com')) return 'X';
        if(h.includes('deezer.com')) return 'Deezer';
        if(h.includes('tidal.com')) return 'Tidal';
        return 'Website';
      }catch{ return 'Website'; }
    }

    function parseYouTubeId(input){
      if(/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
      try{
        const u = new URL(input);
        if(u.hostname.includes('youtu.be')) return u.pathname.split('/')[1] || '';
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const m = u.pathname.match(/\\/embed\\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
      }catch{}
      return '';
    }

    function iconSVG(platform){
      const colorMap = {
        'YouTube':'#FF0000',
        'Spotify':'#1DB954',
        'SoundCloud':'#FF5500',
        'Apple Music':'#FA2A55',
        'Bandcamp':'#629AA9',
        'Instagram':'#E4405F',
        'TikTok':'#EE1D52',
        'X':'#1D9BF0',
        'Deezer':'#EF5466',
        'Tidal':'#01FFFF',
        'Website':'#9fb0c3'
      };
      const fill = colorMap[platform] || '#9fb0c3';
      switch(platform){
        case 'YouTube':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M23 7.5c0-1.5-1.2-2.7-2.7-2.8C17.9 4.3 12 4.3 12 4.3s-5.9 0-8.3.4C2.2 4.8 1 6 1 7.5 1 9.3 1 12 1 12s0 2.7.1 4.5c.1 1.5 1.3 2.6 2.7 2.8 2.4.4 8.2.4 8.2.4s5.9 0 8.3-.4c1.5-.2 2.7-1.3 2.7-2.8C23 14.7 23 12 23 12s0-2.7 0-4.5Zm-13 7.2V9.3l6 2.7-6 2.7Z"></path></svg>`;
        case 'Spotify':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm4.6 14.8a.9.9 0 0 1-1.23.3c-3.35-2.04-7.57-1.25-9.88-.34a.9.9 0 0 1-.68-1.68c2.67-1.08 7.38-1.98 11.2.33.44.26.59.82.3 1.23Zm1.1-3.1a1 1 0 0 1-1.36.34c-3.83-2.27-9.64-1.48-12.56-.4a1 1 0 0 1-.74-1.86c3.36-1.34 9.91-2.23 14.46.44.48.28.65.9.34 1.36Zm.2-3.2a1.1 1.1 0 0 1-1.5.38c-4.46-2.65-11.25-1.73-14.3-.48a1.1 1.1 0 0 1-.82-2.03c3.57-1.44 10.93-2.5 16.3.62.52.31.69 1 .38 1.5Z"></path></svg>`;
        case 'SoundCloud':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M19 10.5c-1.1-2.4-3.9-3.5-6.2-2.6A5 5 0 0 0 7 13H5.5a2.5 2.5 0 1 0 0 5H19a3.5 3.5 0 1 0 0-7Z"></path></svg>`;
        case 'Apple Music':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M16 3 8 5v10.2a2.8 2.8 0 1 0 1.5 2.5V9.2L16 7v6.2a2.8 2.8 0 1 0 1.5 2.5V3Z"></path></svg>`;
        case 'Bandcamp':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M3 16 8.5 8H21l-5.5 8H3Z"></path></svg>`;
        case 'Instagram':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M7 3h10a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4Zm0 2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H7Zm5 2.8A4.2 4.2 0 1 1 7.8 12 4.2 4.2 0 0 1 12 7.8Zm0 2a2.2 2.2 0 1 0 2.2 2.2A2.2 2.2 0 0 0 12 9.8Zm5.2-3.3a1.1 1.1 0 1 1-1.1 1.1 1.1 1.1 0 0 1 1.1-1.1Z"></path></svg>`;
        case 'TikTok':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M14 3h2a5 5 0 0 0 5 5v2a7 7 0 0 1-5-2v6.5A5.5 5.5 0 1 1 10.5 9H12v2a3.5 3.5 0 1 0 2 3.06V3Z"></path></svg>`;
        case 'X':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M3 4h5.6l4.2 6 4.6-6H21l-6.9 9.2L21 20h-5.6l-4.2-6-4.6 6H3l7-9.3L3 4Z"></path></svg>`;
        case 'Deezer':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M3 16h3v3H3v-3Zm4-4h3v7H7v-7Zm4-3h3v10h-3V9Zm4-2h3v12h-3V7Zm4-2h3v14h-3V5Z"></path></svg>`;
        case 'Tidal':
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M7 7 12 12 17 7l3 3-5 5-3-3-3 3-5-5 3-3Z"></path></svg>`;
        default:
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 3a7 7 0 0 1 6.93 6H12V5Z"></path></svg>`;
      }
    }
  </script>
</body>
</html>
